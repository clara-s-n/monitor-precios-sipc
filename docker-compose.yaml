services:
  postgres:
    image: postgres:13
    container_name: airflow-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - postgres-db-volume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow"]
      interval: 5s
      retries: 5

  airflow:
    build: ./airflow
    container_name: airflow
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PYTHONPATH: /opt/airflow/src
      AIRFLOW_HOME: /opt/airflow
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags
      # PostgreSQL connection
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
      # Deshabilitar login
      AIRFLOW__WEBSERVER__AUTHENTICATE: "False"
      _AIRFLOW_WWW_USER_CREATE: "False"
      _AIRFLOW_WWW_USER_USERNAME: admin
      _AIRFLOW_WWW_USER_PASSWORD: admin
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./data_sipc:/opt/airflow/data_sipc
      - ./src:/opt/airflow/src
    ports:
      - "8080:8080"
    command: >
      bash -c "
        set -e
        mkdir -p /opt/airflow/logs /opt/airflow/dags /opt/airflow/plugins
        chmod -R 777 /opt/airflow/logs
        echo 'Initializing Airflow database...'
        airflow db init || airflow db upgrade
        echo 'Creating admin user...'
        airflow users create --username admin --firstname Airflow --lastname Admin --email airflowadmin@example.com --role Admin --password admin 2>&1 || echo 'Admin user already exists'
        echo 'Starting webserver and scheduler...'
        airflow webserver --port 8080 &
        exec airflow scheduler
      "

  jupyter:
    image: jupyter/pyspark-notebook:latest
    container_name: jupyter-spark
    restart: unless-stopped
    environment:
      JUPYTER_ENABLE_LAB: "yes"
      JUPYTER_TOKEN: ""
      GRANT_SUDO: "yes"
    user: root
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data_sipc:/home/jovyan/work/data_sipc
      - ./src:/home/jovyan/work/src
    ports:
      - "8888:8888"
    command: start-notebook.sh --NotebookApp.token='' --NotebookApp.password=''

volumes:
  postgres-db-volume:
